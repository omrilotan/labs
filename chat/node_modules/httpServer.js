// requirements
var http = require("http"),
    url = require("url"),
    path = require("path"),
    fs = require("fs"),
    serverResponse = function (request, response) {
        base = process.cwd;

        var constants = {
            ROOT: "/htdocs/",
            INDEX: "/index.html",
            NOT_FOUND: "/404.html"
        };

        var root = base() + constants.ROOT,
            uri = root + url.parse(request.url).pathname,
            filename = path.join(base, uri),
            errorHandler = function (error, code) {
                response.writeHead(code, {"Content-Type": "text/plain"});
                response.write(code + " \n" + error + " \n");
                response.end();
                return;
            };

        path.exists(filename, function(exists) {

            if(!exists) {
                filename =  path.join(root, constants.NOT_FOUND);
                // errorHandler("Not Found " + "(" + filename + ")", 404)
                // return;
            }

            if (fs.statSync(filename).isDirectory()) {
                filename += constants.INDEX;
            }

            fs.readFile(filename, "binary", function(error, file) {
                if (error) {
                    errorHandler(error, 500)
                    return;
                }

                response.writeHead(200);
                response.write(file, "binary");
                response.end();
            });
        });
    };

exports.init = function () {
    port = 1337;
    return http.createServer(serverResponse).listen(parseInt(port, 10), "127.0.0.1");
};